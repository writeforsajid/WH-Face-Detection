<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Guest Presence Report</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f8f9fa;
    }
    h2 {
        text-align: center;
        margin-bottom: 20px;
    }
    .filters {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    .filters div {
        display: flex;
        flex-direction: column;
        align-items: start;
    }
    label {
        font-weight: bold;
        margin-bottom: 4px;
    }
    input[type="date"] {
        padding: 6px;
    }
    button {
        padding: 8px 16px;
        font-weight: bold;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        align-self: center;
    }
    button:hover {
        background: #0056b3;
    }
    .tables {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
    }
    .table-container {
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        flex: 1;
        min-width: 320px;
        max-width: 48%;
    }
    .table-container h3 {
        margin: 0;
        text-align: center;
        background: #f1f1f1;
        padding: 8px;
        border-radius: 6px 6px 0 0;
        font-size: 1rem;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    thead {
        background: #eaeaea;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    th, td {
        padding: 6px 8px;
        border-bottom: 1px solid #eee;
        text-align: left;
        font-size: 0.95rem;
    }
    tbody {
        display: block;
        height: 220px;
        overflow-y: auto;
    }
    thead, tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    .bottom-table {
        margin-top: 25px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .bottom-table h3 {
        margin: 0;
        text-align: center;
        background: #f1f1f1;
        padding: 8px;
        border-radius: 6px 6px 0 0;
    }
    .red {
        color: red;
        font-weight: bold;
    }

    /* Responsive layout for mobile */
    @media (max-width: 768px) {
        .tables {
            flex-direction: column;
        }
        .table-container {
            max-width: 100%;
        }
        .filters {
            flex-direction: column;
            align-items: center;
        }
        .filters div, button {
            width: 90%;
        }
    }
</style>
</head>
<body>
<h2>Guest Presence Report</h2>

<div class="filters">
    <div>
        <label>From Date:</label>
        <input type="date" id="fromDate" disabled />
    </div>
    <div>
        <label>Till Date:</label>
        <input type="date" id="tillDate" />
    </div>
    <button id="runReport">Run Report</button>
</div>

<div class="tables">
    <div class="table-container">
        <h3>Not Present (Top 7)</h3>
        <table>
            <thead>
                <tr><th>Name - Bed</th><th>Missing (hrs)</th></tr>
            </thead>
            <tbody id="notPresentBody"></tbody>
        </table>
    </div>
    <div class="table-container">
        <h3>Present (Top 7)</h3>
        <table>
            <thead>
                <tr><th>Name - Bed</th><th>Missing (hrs)</th></tr>
            </thead>
            <tbody id="presentBody"></tbody>
        </table>
    </div>
</div>

<div class="bottom-table">
    <h3>Others</h3>
    <table>
        <thead>
            <tr><th>Name - Bed</th><th>Missing (hrs)</th></tr>
        </thead>
        <tbody id="othersBody"></tbody>
    </table>
</div>

<script>
function updateFromDate() {
    const tillDate = document.getElementById("tillDate").value;
    if (!tillDate) return;
    const till = new Date(tillDate);
    const from = new Date(till);
    from.setDate(till.getDate() - 2); // 48 hours before
    document.getElementById("fromDate").value = from.toISOString().split("T")[0];
}

document.getElementById("tillDate").addEventListener("change", updateFromDate);

document.getElementById("runReport").addEventListener("click", async () => {
    const tillDate = document.getElementById("tillDate").value;
    if (!tillDate) {
        alert("Please select Till Date");
        return;
    }

    updateFromDate();
    const url = `/reports/guest_presence?till_date=${tillDate}`;
    try {
        const res = await fetch(url);
        const data = await res.json();

        const allData = data.data || [];

        // Split and sort data
        const notPresentAll = allData.filter(g => g.current_status === 'not present');
        const presentAll = allData.filter(g => g.current_status === 'present');

        const notPresentTop = notPresentAll.slice(0, 7);
        const presentTop = presentAll.slice(0, 7);

        const others = allData.filter(g => 
            !notPresentTop.includes(g) && 
            !presentTop.includes(g)
        );

        const formatRow = (g) => `
            <tr>
                <td>${g.name} - ${g.bed_id || '-'}</td>
                <td class="${g.current_status === 'not present' ? 'red' : ''}">
                    ${g.missing_hrs ?? '-'}
                </td>
            </tr>`;

        document.getElementById("notPresentBody").innerHTML = notPresentTop.map(formatRow).join('') || "<tr><td colspan='2'>No data</td></tr>";
        document.getElementById("presentBody").innerHTML = presentTop.map(formatRow).join('') || "<tr><td colspan='2'>No data</td></tr>";
        document.getElementById("othersBody").innerHTML = others.map(formatRow).join('') || "<tr><td colspan='2'>No data</td></tr>";

    } catch (err) {
        console.error(err);
        alert("Error fetching report.");
    }
});

// Default till date = today
const today = new Date().toISOString().split("T")[0];
document.getElementById("tillDate").value = today;
updateFromDate();
</script>
</body>
</html>
