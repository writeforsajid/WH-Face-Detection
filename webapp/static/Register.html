<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guest Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .form-label span { color: #dc3545; }
  </style>
</head>

<body class="bg-light">
<div class="container mt-4 mb-5">
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white text-center">
      <h4 class="mb-0">Guest Registration (5s Video Capture)</h4>
    </div>

    <div class="card-body">
      <form id="guestForm" novalidate>

        <!-- Row 1: Name -->
        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">Name <span>*</span></label>
            <input type="text" id="name" name="name" class="form-control" required>
            <div class="invalid-feedback">Please enter guest name.</div>
          </div>
        </div>

        <!-- Row 2: Guest type & Bed no -->
        <div class="row mb-3">
          <div class="col-md-6 col-12">
            <label class="form-label">Guest Type</label>
            <select id="guest_type" name="guest_type" class="form-control">
              <option value="2">Residence</option>
              <option value="1">Employee</option>
              <option value="0">Owner</option>
            </select>
          </div>

          <div class="col-md-6 col-12">
            <label class="form-label">Bed No <span>*</span></label>
            <input type="text" id="comment" name="comment" class="form-control" >
            <!--<div class="invalid-feedback">Please select a bed number.</div> -->
          </div>
        </div>

        <!-- Row 3: Email & Phone -->
        <div class="row mb-3">
          <div class="col-md-6 col-12">
            <label class="form-label">Email <span>*</span></label>
            <input type="email" id="email" name="email" class="form-control" required>
            <div class="invalid-feedback">Please enter a valid email address.</div>
          </div>
          <div class="col-md-6 col-12">
            <label class="form-label">Phone Number <span>*</span></label>
            <input type="tel" id="phone" name="phone" class="form-control" required pattern="^[6-9]\\d{9}$">
            <div class="invalid-feedback">Enter a valid 10-digit phone number.</div>
          </div>
        </div>

        <div class="alert alert-warning py-2 px-3" role="alert">
          ‚ö†Ô∏è <strong>Note:</strong> Please capture the <u>5-second video</u> <b>after filling the form</b>.
        </div>

        <!-- Video Section -->
        <div class="text-center mb-3">
          <video id="videoPreview" width="100%" height="260" autoplay muted class="border rounded mb-2 bg-dark"></video>
          <div class="row g-2">
            <div class="col-md-6 col-12 d-grid">
              <button type="button" id="btnRecord" class="btn btn-warning">üé• Record 5s Video</button>
            </div>
            <div class="col-md-6 col-12 d-grid">
              <button type="button" id="btnSwitch" class="btn btn-secondary">üîÅ Switch Camera</button>
            </div>
          </div>
          <p class="text-muted small mt-2" id="videoStatus">Video not captured yet.</p>
          <button type="button" id="btnRetake" class="btn btn-outline-secondary w-100 mt-2 d-none">‚Ü©Ô∏è Retake Video</button>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3">üíæ Save Guest</button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
let mediaRecorder, recordedChunks = [], cameraStream = null;
let currentFacing = "environment";
let guest_id = null;

// ------------------ Validate Form ------------------

// ------------------ Validate Form ------------------
function validateForm() {
  let valid = true;
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const phonePattern = /^[6-9]\d{9}$/; // Indian mobile format example

  $("#name, #email, #phone, #comment").removeClass("is-invalid");

  if (!$("#name").val().trim()) {
    $("#name").addClass("is-invalid"); valid = false;
  }
  console.log(valid);
  if (!$("#email").val().trim() || !emailPattern.test($("#email").val().trim())) {
    $("#email").addClass("is-invalid"); valid = false;
  }
  console.log(valid);
  if (!$("#phone").val().trim() || !phonePattern.test($("#phone").val().trim())) {
    $("#phone").addClass("is-invalid"); valid = false;
  }
  console.log(valid);
  if (!$("#comment").val().trim()) {
    $("#comment").addClass("is-invalid"); valid = false;
  }

  console.log(valid);

  return valid;
}

// ------------------ Start Camera ------------------
// ------------------ Start Camera ------------------
async function startCamera() {
  try {
    if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());

    const mimeType = MediaRecorder.isTypeSupported("video/webm;codecs=vp9")
      ? "video/webm;codecs=vp9"
      : "video/webm;codecs=vp8";

    let constraints = {
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 2560 },
        height: { ideal: 1440 }
      },
      audio: false
    };

    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
  } catch (err) {
    console.warn("‚ö†Ô∏è Retrying with default camera...");
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    } catch (finalErr) {
      alert("Unable to access any camera: " + finalErr.message);
      console.error(finalErr);
      return;
    }
  }

  const videoElement = document.getElementById("videoPreview");
  videoElement.srcObject = cameraStream;

  const mimeType = MediaRecorder.isTypeSupported("video/webm;codecs=vp9")
    ? "video/webm;codecs=vp9"
    : "video/webm;codecs=vp8";

  mediaRecorder = new MediaRecorder(cameraStream, {
    mimeType,
    videoBitsPerSecond: 8_000_000
  });

  recordedChunks = [];
  mediaRecorder.ondataavailable = e => e.data && recordedChunks.push(e.data);
  mediaRecorder.onstop = () => uploadVideo();

  console.log(`üé• Camera started (${currentFacing})`);
}

// ------------------ Switch Camera ------------------
$("#btnSwitch").click(async () => {
  currentFacing = currentFacing === "environment" ? "user" : "environment";
  await startCamera();
  $("#videoStatus").text(`Switched to ${currentFacing} camera.`);
});

// ------------------ Record Button ------------------
$("#btnRecord").click(() => {
  if (!validateForm()) { alert("Please fill in all required fields correctly."); return; }
  if (!mediaRecorder) return startCamera().then(() => $("#btnRecord").click());
  recordedChunks = [];
  mediaRecorder.start();
  $("#btnRecord").text("Recording...").prop("disabled", true);
  $("#videoStatus").text("Recording video...");
  setTimeout(() => {
    mediaRecorder.stop();
    $("#btnRecord").text("üé• Record 5s Video").prop("disabled", false);
  }, 5000);
});

// ------------------ Upload + Preview ------------------
function uploadVideo() {
  const blob = new Blob(recordedChunks, { type: "video/webm" });
  const formData = new FormData();
  const guestName = $("#name").val() || "Unknown";
  const guestType = $("#guest_type option:selected").text();
  const comment = $("#comment").val() || "000";
  const email = $("#email").val();
  const phone = $("#phone").val();
  
  formData.append("guest_name", guestName);
  formData.append("guest_type", guestType);
  formData.append("comment", comment);
  formData.append("email",email);
  formData.append("phone", phone);
  formData.append("file", blob, `${guestName.replace(/\s+/g, "_")}.webm`);
  console.log(guestName);console.log(guestType);
  console.log(comment);console.log(email);
  console.log(phone);
  fetch(`/video/upload_video`, { method: "POST", body: formData })
    .then(async r => {
      if (!r.ok) throw new Error("Upload failed");
      const res = await r.json();
      if (res.status) {
        const videoElement = document.getElementById('videoPreview');
        if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; }
        videoElement.srcObject = null;
        videoElement.src = `./temp/preview.webm`;
        videoElement.controls = true;
        videoElement.autoplay = true;
        videoElement.muted = false;
        guest_id = res.guest_id;
        $("#videoStatus").html("‚úÖ Video uploaded! Showing preview below.");
        $("#btnRetake").removeClass("d-none");
      } else {
        $("#videoStatus").text("‚úÖ Uploaded but no preview returned.");
      }
    })
    .catch(() => $("#videoStatus").text("‚ùå Error uploading video."));
}

// ------------------ Retake Video ------------------
$("#btnRetake").click(() => {
  $("#btnRetake").addClass("d-none");
  $("#videoStatus").text("Ready to record new video.");
  startCamera();
});

// ------------------ Submit Form ------------------
$("#guestForm").submit(function (e) {
  e.preventDefault();
  if (!validateForm()) return;
  if (!guest_id) { alert("Please record video before saving!"); return; }

  const guest = {
    name: $("#name").val().trim(),
    guest_type: $("#guest_type option:selected").text(),
    email: $("#email").val().trim(),
    phone: $("#phone").val().trim()
  };

  $.ajax({
    url: `/guests/${guest_id}/confirm`,
    type: "POST",
    data: JSON.stringify(guest),
    contentType: "application/json",
    success: function (res) {
      alert(res.message || "Guest saved successfully!");
      $("#guestForm")[0].reset();
      $("#videoStatus").text("Video not captured yet.");
      $("#videoPreview").attr("srcObject", null).attr("src", "");
      $("#videoPreview")[0].controls = false;
      $("#btnRetake").addClass("d-none");
      startCamera();
    },
    error: function (xhr) {
      alert(xhr.responseText || "Server error while saving guest.");
    }
  });
});


// ------------------ Init ------------------
$(document).ready(function () {

  startCamera();
});
</script>
</body>
</html>
