<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Change / Reset Password</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial; padding: 30px; background: #f3f3f3; }
    form { background: #fff; padding: 20px; max-width: 400px; margin: auto; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    label { display: block; margin: 10px 0 5px; }
    input { width: 100%; padding: 10px; box-sizing: border-box; }
    button { margin-top: 15px; padding: 10px; width: 100%; background: #007BFF; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .toggle { text-align: right; margin-top: 10px; color: #007BFF; cursor: pointer; font-size: 14px; }
  </style>
</head>
<body>

<form id="changePasswordForm">
  <h2>Change / Reset Password</h2>
  
  <div id="oldPasswordGroup">
    <label for="oldPassword">Old Password</label>
    <input type="password" id="oldPassword" placeholder="Enter old password">
  </div>

  <div id="secretKeyGroup" style="display:none;">
    <label for="secretKey">4-Character Secret Key</label>
    <input type="text" id="secretKey" maxlength="4" placeholder="e.g. A7B2">
  </div>

  <label for="newPassword">New Password</label>
  <input type="password" id="newPassword" placeholder="Enter new password">

  <label for="confirmPassword">Confirm New Password</label>
  <input type="password" id="confirmPassword" placeholder="Re-enter new password">

  <button type="submit">Update Password</button>

  <div class="toggle" id="toggleMode">Forgot Password?</div>
</form>

<script>
let forgotMode = false;

$("#toggleMode").on("click", function() {
  forgotMode = !forgotMode;
  if (forgotMode) {
    $("#oldPasswordGroup").hide();
    $("#secretKeyGroup").show();
    $("#toggleMode").text("Remembered Old Password?");
  } else {
    $("#oldPasswordGroup").show();
    $("#secretKeyGroup").hide();
    $("#toggleMode").text("Forgot Password?");
  }
});

$("#changePasswordForm").on("submit", function(e) {
  e.preventDefault();

  const oldPassword = $("#oldPassword").val();
  const secretKey = $("#secretKey").val();
  const newPassword = $("#newPassword").val();
  const confirmPassword = $("#confirmPassword").val();

  if (newPassword !== confirmPassword) {
    alert("❌ New passwords do not match!");
    return;
  }

  // Prepare form data
  const formData = new FormData();
  if (forgotMode) {
    formData.append("secret_key", secretKey);
  } else {
    formData.append("old_password", oldPassword);
  }
  formData.append("new_password", newPassword);

  // Send securely using HTTPS (important!)
  fetch("/guest/change_password", {
    method: "POST",
    body: formData,
  })
  .then(r => {
    if (!r.ok) throw new Error("Server error");
    return r.json();
  })
  .then(data => {
    alert(data.message || "✅ Password updated successfully!");
  })
  .catch(err => alert("❌ Failed: " + err.message));
});
</script>

</body>
</html>
